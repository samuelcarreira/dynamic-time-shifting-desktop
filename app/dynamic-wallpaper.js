/*!
 * Dynamic Time-shifting Desktop main Class
 * 
 * @author    Samuel Carreira <samuelcarreira@outlook.com>
 * @copyright (C) 2018 Samuel Carreira
 * @license   MIT
 * @version   See package.json
 */"use strict";const EventEmitter=require("events").EventEmitter,{promisify}=require("util"),exec=promisify(require("child_process").exec),execFile=promisify(require("child_process").execFile),wallpaper=require("wallpaper"),fsoperations=require("./fsoperations");module.exports=class extends EventEmitter{constructor(a){super(),this._wallpapers=a,this.init(),this._linuxDesktop=null}set setWallpapers(a){this._wallpapers=a}addWallpapers(a){a.forEach(a=>{this._wallpapers.push(a)})}get nowPercentage(){const a=new Date,b=3600*a.getHours()+60*a.getMinutes()+a.getSeconds();return b/86400}get currentSystemWallpaper(){return new Promise((a,b)=>{wallpaper.get().then(b=>{a(b)}).catch(a=>{b(a)})})}get numberOfWallpapers(){return this._wallpapers.length}get wallpapersList(){return this._wallpapers}async getDesktopEnv(){try{const a=await exec("echo $XDG_CURRENT_DESKTOP");return a.includes("GNOME")?"gnome":!!a.includes("LXDE")&&"lxde"}catch(a){return!1}}init(){this.calculateWallpaper(),setInterval(()=>{this.calculateWallpaper()},6e5)}calculateWallpaperFile(a=null){if(!this.numberOfWallpapers)return!1;a=null==a?this.nowPercentage:a,0>a&&(a=0),1<a&&(a=1);const b=Math.round(a*(this.numberOfWallpapers-1));return global.Log.debug(`Wallpaper ${b+1} of ${this.numberOfWallpapers}`),this._wallpapers[b]}calculateWallpaper(){if(this.numberOfWallpapers){const a=Math.round(this.nowPercentage*(this.numberOfWallpapers-1));global.Log.debug(`Wallpaper ${a+1} of ${this.numberOfWallpapers}`),this.changeWallpaper(this._wallpapers[a])}}async changeWallpaper(a){try{if(null===!this._linuxDesktop){const b=await this.currentSystemWallpaper;if(b===a)return}const b=await fsoperations.checkReadPermissions(a);if(!b)return void global.Log.error(`Cannot read wallpaper file: ${a}`);"linux"===process.platform?(null===this._linuxDesktop&&(this._linuxDesktop=await this.getDesktopEnv()),"gnome"===this._linuxDesktop?execFile("gsettings",["set","org.gnome.desktop.background","picture-uri",`'file://${a}'`],a=>{if(a)return void global.Log.error(`Cannot change wallpaper: ${a}`)}):"lxde"===this._linuxDesktop?exec(`pcmanfm --set-wallpaper='${a}'`,a=>{if(a)return void global.Log.error(`Cannot change wallpaper: ${a}`)}):wallpaper.set(a)):wallpaper.set(a),this.emit("wallpaperChanged"),global.Log.info(`Wallpaper changed to: ${a}`)}catch(a){global.Log.error(`Cannot change wallpaper: ${a}`)}}};